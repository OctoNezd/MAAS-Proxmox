#!/usr/bin/env python3
# curtin-hooks - Curtin installation hooks for Ubuntu
#
# Copyright (C) 2022 Canonical
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

import os
import shutil
import glob
import yaml

from curtin.commands.curthooks import builtin_curthooks
from curtin.config import load_command_config
from curtin.util import load_command_environment


def configure_proxmox_network(target):
    """Convert MAAS netplan config to Proxmox /etc/network/interfaces.

    Reads netplan YAML files created by MAAS, extracts network configuration,
    and converts to /etc/network/interfaces format with vmbr0 bridge.
    """
    print("Converting netplan to Proxmox network configuration...")

    # Find netplan config files in target
    netplan_files = glob.glob(os.path.join(target, "etc/netplan/*.yaml"))

    if not netplan_files:
        print("WARNING: No netplan files found, skipping network configuration")
        return

    # Read the netplan configuration
    netplan_config = {}
    for netplan_file in netplan_files:
        print(f"Reading {netplan_file}")
        with open(netplan_file, 'r') as f:
            config_data = yaml.safe_load(f)
            if config_data:
                netplan_config.update(config_data)

    # Extract network configuration
    network = netplan_config.get('network', {})
    ethernets = network.get('ethernets', {})

    if not ethernets:
        print("WARNING: No ethernet interfaces found in netplan config")
        return

    # Find the interface with IP configuration
    configured = False
    for iface_name, iface_cfg in ethernets.items():
        if 'addresses' in iface_cfg and iface_cfg['addresses']:
            # Extract configuration
            ip_address = iface_cfg['addresses'][0]
            gateway = iface_cfg.get('gateway4') or iface_cfg.get('gateway')
            nameservers = iface_cfg.get('nameservers', {})
            dns_servers = nameservers.get('addresses', ['8.8.8.8', '8.8.4.4'])

            print(f"Configuring bridge vmbr0 on {iface_name}: {ip_address}, gateway: {gateway}")

            # Write /etc/network/interfaces
            interfaces_path = os.path.join(target, "etc/network/interfaces")
            with open(interfaces_path, 'w') as f:
                f.write("# network interface settings; autogenerated by curtin\n")
                f.write("# Converted from netplan for Proxmox VE compatibility\n")
                f.write("\n")
                f.write("auto lo\n")
                f.write("iface lo inet loopback\n")
                f.write("\n")
                f.write(f"auto {iface_name}\n")
                f.write(f"iface {iface_name} inet manual\n")
                f.write("\n")
                f.write("auto vmbr0\n")
                f.write("iface vmbr0 inet static\n")
                f.write(f"    address {ip_address}\n")
                if gateway:
                    f.write(f"    gateway {gateway}\n")
                if dns_servers:
                    f.write(f"    dns-nameservers {' '.join(dns_servers)}\n")
                f.write(f"    bridge-ports {iface_name}\n")
                f.write("    bridge-stp off\n")
                f.write("    bridge-fd 0\n")

            print(f"Created {interfaces_path}")
            configured = True
            break

    if not configured:
        print("WARNING: No interface with IP address found in netplan config")
        return

    # Disable cloud-init network management
    cloud_cfg_dir = os.path.join(target, "etc/cloud/cloud.cfg.d")
    os.makedirs(cloud_cfg_dir, exist_ok=True)

    cloud_cfg_path = os.path.join(cloud_cfg_dir, "99-disable-network-config.cfg")
    with open(cloud_cfg_path, 'w') as f:
        f.write("network: {config: disabled}\n")

    print(f"Created {cloud_cfg_path} to disable cloud-init network management")
    print("Proxmox network configuration complete")


def configure_custom_kernel(config):
    """Amend the curtin config to explicity specify the kernel to install.

    The name of the kernel to install should already have been written to the
    CUSTOM_KERNEL file in the same directory as this file.
    """
    custom_kernel_path = os.path.join(
        os.path.dirname(__file__), "CUSTOM_KERNEL")
    with open(custom_kernel_path, "r") as custom_kernel_file:
        custom_kernel_package = custom_kernel_file.read().strip()
    kernel_config = config.setdefault("kernel", {})
    kernel_config["package"] = custom_kernel_package
    return config


def cleanup():
    """Remove curtin-hooks so its as if we were never here."""
    curtin_dir = os.path.dirname(__file__)
    shutil.rmtree(curtin_dir)


def main():
    state = load_command_environment()
    config = load_command_config(None, state)
    target = state['target']

    config = configure_custom_kernel(config)
    configure_proxmox_network(target)
    builtin_curthooks(config, target, state)
    cleanup()


if __name__ == "__main__":
    main()
